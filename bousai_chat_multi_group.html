<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>é˜²ç½ãƒãƒ£ãƒƒãƒˆ</title>

  <style>
    body { font-family: sans-serif; padding: 20px; }
    #map { height: 300px; margin-bottom: 20px; }
    #chat-box { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: scroll; margin-bottom: 10px; }
    #group-form input, #group-form select, #group-form button { margin: 5px; }
    #status-buttons button { margin: 5px; }
  </style>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>

<h1>é˜²ç½ãƒãƒ£ãƒƒãƒˆ</h1>

<!-- ã‚°ãƒ«ãƒ¼ãƒ—ç™»éŒ²ã¨é¸æŠ -->
<div id="group-form">
  ã‚°ãƒ«ãƒ¼ãƒ—å<input type="text" id="new-group-id" placeholder="ï¼ˆä¾‹ï¼šä¸–å¸¯ä¸»åï¼‰">
  <input type="text" id="new-user-name" placeholder="ã‚ãªãŸã®åå‰">
  <button id="add-group-btn">ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¿½åŠ </button>
  <br>

  <select id="group-selector">
    <option value="">ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠ</option>
  </select>

  <button id="delete-group-btn">é¸æŠä¸­ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤</button>
</div>

<div id="map"></div>

<input type="text" id="chat-input" placeholder="è‡ªç”±ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
<button id="send-btn">é€ä¿¡</button>

<div id="status-buttons">
  <button data-status="âœ… ç„¡äº‹ã§ã™">âœ… ç„¡äº‹ã§ã™</button>
  <button data-status="ğŸš¶â€â™‚ï¸ é¿é›£ä¸­">ğŸš¶â€â™‚ï¸ é¿é›£ä¸­</button>
  <button data-status="ğŸ†˜ åŠ©ã‘ã¦">ğŸ†˜ åŠ©ã‘ã¦</button>
</div>

<div id="chat-box"></div>

<!-- Firebase & ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, remove } 
    from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

  console.log("âœ… Firebase ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿å®Œäº†");

  const firebaseConfig = {
    apiKey: "AIzaSyCkxNrfkFmCpiCYGBj56kDzGeI-EoBLiRw",
    authDomain: "bousai-chat.firebaseapp.com",
    databaseURL: "https://bousai-chat-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "bousai-chat",
    storageBucket: "bousai-chat.firebasestorage.app",
    messagingSenderId: "65481189747",
    appId: "1:65481189747:web:0e7c47f05c5878428c3d06"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  console.log("âœ… Firebase åˆæœŸåŒ–å®Œäº†");

  let currentGroup = null;

  /* -------------------------
     åœ°å›³è¡¨ç¤º
  ------------------------- */
  console.log("âœ… åœ°å›³åˆæœŸåŒ–é–‹å§‹");

  const map = L.map('map').setView([34.7101, 137.7265], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    console.log("âœ… ç¾åœ¨åœ°å–å¾—:", lat, lng);
    L.marker([lat, lng]).addTo(map).bindPopup("ã‚ãªãŸã®ç¾åœ¨åœ°").openPopup();
  });

  /* -------------------------
     ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†
  ------------------------- */

  function updateGroupSelector() {
    console.log("âœ… updateGroupSelector å®Ÿè¡Œ");

    const selector = document.getElementById("group-selector");
    selector.innerHTML = '<option value="">ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠ</option>';

    const groups = JSON.parse(localStorage.getItem("groupList") || "[]");
    console.log("ğŸ“Œ ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§:", groups);

    groups.forEach(g => {
      const op = document.createElement("option");
      op.value = g.groupId;
      op.textContent = `${g.groupId}ï¼ˆ${g.name}ï¼‰`;
      selector.appendChild(op);
    });
  }

  function selectGroup(groupId) {
    console.log("âœ… selectGroup å‘¼ã³å‡ºã—:", groupId);

    const groups = JSON.parse(localStorage.getItem("groupList") || "[]");
    const selected = groups.find(g => g.groupId === groupId);

    if (!selected) {
      console.log("âŒ selectGroup: ã‚°ãƒ«ãƒ¼ãƒ—ãŒè¦‹ã¤ã‹ã‚‰ãªã„");
      return;
    }

    currentGroup = selected.groupId;
    localStorage.setItem("groupId", selected.groupId);
    localStorage.setItem("userName", selected.name);

    console.log("âœ… currentGroup è¨­å®š:", currentGroup);

    loadMessages(currentGroup);
  }

  function addGroup() {
    const groupId = document.getElementById("new-group-id").value.trim();
    const name = document.getElementById("new-user-name").value.trim();

    console.log("âœ… addGroup:", groupId, name);

    if (!groupId || !name) {
      alert("ã‚°ãƒ«ãƒ¼ãƒ—åã¨åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    const groups = JSON.parse(localStorage.getItem("groupList") || "[]");

    if (groups.some(g => g.groupId === groupId)) {
      alert("åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—åãŒå­˜åœ¨ã—ã¾ã™");
      return;
    }

    groups.push({ groupId, name });
    localStorage.setItem("groupList", JSON.stringify(groups));

    updateGroupSelector();

    document.getElementById("group-selector").value = groupId;
    selectGroup(groupId);
  }

  function deleteGroup() {
    const selector = document.getElementById("group-selector");
    const groupId = selector.value;

    console.log("âœ… deleteGroup:", groupId);

    if (!groupId) {
      alert("å‰Šé™¤ã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }

    const groups = JSON.parse(localStorage.getItem("groupList") || "[]");
    const updated = groups.filter(g => g.groupId !== groupId);
    localStorage.setItem("groupList", JSON.stringify(updated));

    if (currentGroup === groupId) {
      currentGroup = null;
      localStorage.removeItem("groupId");
      localStorage.removeItem("userName");
      document.getElementById("chat-box").innerHTML = "";
    }

    updateGroupSelector();
  }

  /* -------------------------
     ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èª­ã¿è¾¼ã¿
  ------------------------- */
  function loadMessages(groupId) {
    console.log("âœ… loadMessages å‘¼ã³å‡ºã—:", groupId);

    const chatBox = document.getElementById("chat-box");
    chatBox.innerHTML = "";

    const path = `${groupId}/messages`;
    console.log("ğŸ“¡ Firebase ç›£è¦–ãƒ‘ã‚¹:", path);

    onChildAdded(ref(db, path), snapshot => {
      console.log("âœ… onChildAdded ç™ºç«:", snapshot.key, snapshot.val());

      const msg = snapshot.val();
      const time = new Date(msg.time).toLocaleTimeString();

      const div = document.createElement("div");
      div.textContent = `[${time}] ${msg.sender}ï¼š${msg.text}`;

      // å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆå¿…è¦ãªã‚‰ï¼‰
      const delBtn = document.createElement("button");
      delBtn.textContent = "å‰Šé™¤";
      delBtn.style.marginLeft = "10px";
      delBtn.onclick = () => {
        remove(ref(db, `${groupId}/messages/${snapshot.key}`))
          .then(() => div.remove())
          .catch(err => console.error("âŒ å‰Šé™¤å¤±æ•—:", err));
      };

      div.appendChild(delBtn);
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  /* -------------------------
     ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
  ------------------------- */
  function sendMessage() {
    console.log("âœ… sendMessage å‘¼ã³å‡ºã—ã€‚currentGroup:", currentGroup);

    if (!currentGroup) return alert("ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„");

    const name = localStorage.getItem("userName") || "åŒ¿å";
    const input = document.getElementById("chat-input");

    if (!input.value.trim()) return;

    const message = {
      type: "chat",
      sender: name,
      text: input.value,
      time: Date.now()
    };

    console.log("ğŸ“¤ é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:", message);

    push(ref(db, `${currentGroup}/messages`), message)
      .then(() => console.log("âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æˆåŠŸ"))
      .catch(err => console.error("âŒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å¤±æ•—:", err));

    input.value = "";
  }

  function sendStatus(status) {
    console.log("âœ… sendStatus:", status);

    if (!currentGroup) return alert("ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„");

    const name = localStorage.getItem("userName") || "åŒ¿å";

    const message = {
      type: "status",
      sender: name,
      text: status,
      time: Date.now()
    };

    console.log("ğŸ“¤ é€ä¿¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:", message);

    push(ref(db, `${currentGroup}/messages`), message)
      .then(() => console.log("âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é€ä¿¡æˆåŠŸ"))
      .catch(err => console.error("âŒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é€ä¿¡å¤±æ•—:", err));
  }

  /* -------------------------
     ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
  ------------------------- */
  document.getElementById("add-group-btn").onclick = addGroup;
  document.getElementById("delete-group-btn").onclick = deleteGroup;
  document.getElementById("send-btn").onclick = sendMessage;

  document.getElementById("group-selector").addEventListener("change", e => {
    selectGroup(e.target.value);
  });

  document.querySelectorAll("#status-buttons button").forEach(btn => {
    btn.onclick = () => sendStatus(btn.dataset.status);
  });

  /* -------------------------
     åˆæœŸåŒ–
  ------------------------- */
  console.log("âœ… åˆæœŸåŒ–å‡¦ç†é–‹å§‹");

  updateGroupSelector();

  const savedGroup = localStorage.getItem("groupId");
  if (savedGroup) {
    console.log("âœ… ä¿å­˜ã•ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ã‚’å¾©å…ƒ:", savedGroup);
    document.getElementById("group-selector").value = savedGroup;
    selectGroup(savedGroup);
  }

</script>

</body>
</html>